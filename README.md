```markdown
# UnityMotionControl - https://github.com/Ali-Rashidi-80/UnityMotionControl

پروژه **UnityMotionControl** یک سیستم کنترل حرکتی پیشرفته است که با استفاده از حسگر **MPU6050** و سرووهای متصل، امکان خواندن داده‌های حرکتی و ارسال دستورات کنترلی به سرووها را فراهم می‌کند. این سیستم از پروتکل **WebSocket** برای برقراری ارتباط real-time بهره می‌برد و با استفاده از کتابخانه **uasyncio** امکان اجرای همزمان چندین سرور (برای ارسال داده‌های حسگر و دریافت دستورات کنترل سروو) را فراهم می‌کند.

---

## فهرست مطالب

- [ویژگی‌ها](#ویژگی‌ها)
- [پیش‌نیازها](#پیشنیازها)
- [معماری سیستم](#معماری-سیستم)
- [ساختار کد](#ساختار-کد)
- [نصب و راه‌اندازی](#نصب-و-راه‌اندازی)
- [تنظیمات و پیکربندی](#تنظیمات-و-پیکربندی)
- [مثال‌های استفاده](#مثال‌های-استفاده)
- [عیب‌یابی و رفع اشکال](#عیب‌یابی-و-رفع-اشکال)
- [سهم در توسعه](#سهم-در-توسعه)
- [مجوز](#مجوز)
- [سازنده](#سازنده)

---

## ویژگی‌ها

- **دریافت و ارسال زنده داده‌های حسگر:**  
  - خواندن داده‌های شتاب‌سنج (Accelerometer) و ژیروسکوپ (Gyroscope) از MPU6050.
  - محاسبه زوایا (pitch, roll, yaw) و g-force به صورت ریاضی.
  - ارسال داده‌ها به کلاینت‌ها به صورت JSON از طریق WebSocket (پورت **8800**).

- **کنترل دقیق سروو:**  
  - دریافت دستورات کنترلی سروو (زاویه محورهای X, Y, Z) از طریق WebSocket (پورت **8765**).
  - تبدیل مقادیر زاویه به سیگنال PWM با استفاده از نگاشت (Mapping) مناسب.
  - کنترل چند سروو به صورت همزمان با استفاده از PWM.

- **ارتباط real-time با WebSocket:**  
  - برقراری ارتباط دوجانبه به صورت real-time.
  - استفاده از توابع handshake و فریم‌بندی برای ارتباط امن و بهینه.

- **برنامه‌نویسی غیرهمزمان (Asynchronous):**  
  - استفاده از کتابخانه uasyncio برای مدیریت همزمان چندین سرور و بهبود کارایی.

- **گسترش‌پذیری و انعطاف‌پذیری:**  
  - امکان افزودن و تغییر ویژگی‌های جدید در سیستم با ساختار مدولار.
  - قابلیت اتصال به انواع میکروکنترلرهای سازگار (مانند ESP32).

---

## پیشنیازها

### سخت‌افزار

- **میکروکنترلر:**  
  - دستگاهی با پشتیبانی از MicroPython (مثلاً ESP32 یا مشابه)

- **حسگر MPU6050:**  
  - برای خواندن داده‌های شتاب‌سنج و ژیروسکوپ

- **سروو:**  
  - حداقل ۳ عدد سروو (برای محورهای X, Y, Z)

- **ماژول WiFi:**  
  - برای اتصال بی‌سیم به شبکه اینترنت/محلی

### نرم‌افزار

- **MicroPython:**  
  - نسخه‌ای که از کتابخانه‌های uasyncio، ujson، ubinascii، utime و ... پشتیبانی می‌کند.

- **کتابخانه‌های اضافی:**  
  - **wifi:** برای مدیریت اتصال به شبکه (شامل توابع `connect_wifi()`، `ensure_wifi_connection()` و شی `wlan`)
  - **mpu6050:** کلاس اختصاصی جهت خواندن داده از حسگر MPU6050

> **نکته:** اطمینان حاصل کنید که کتابخانه‌های `wifi` و `mpu6050` به درستی در محیط MicroPython نصب یا آپلود شده‌اند.

---

## معماری سیستم

سیستم به دو بخش اصلی تقسیم می‌شود:

1. **سرور MPU6050 (پورت 8800):**  
   - وظیفه: خواندن داده‌های شتاب‌سنج و ژیروسکوپ، پردازش و ارسال آن‌ها به کلاینت‌ها.
   - عملیات: خواندن داده از MPU6050 → محاسبه زوایا (pitch, roll, yaw) و g-force → رمزگذاری داده به JSON → ساخت فریم WebSocket → ارسال به کلاینت.

2. **سرور سروو (پورت 8765):**  
   - وظیفه: دریافت دستورات کنترلی (زاویه‌های سروو) از کلاینت‌ها و اعمال آن‌ها روی سرووها.
   - عملیات: دریافت پیام از طریق WebSocket → پردازش فریم و استخراج داده‌ها → نگاشت زاویه به سیگنال PWM → تنظیم سرووها.

هر دو سرور پس از اطمینان از اتصال به WiFi به صورت همزمان با استفاده از **uasyncio** اجرا می‌شوند.

---

## ساختار کد

```plaintext
UnityMotionControl/
├── README.md                # مستندات جامع پروژه
├── LICENSE                  # فایل مجوز (MIT)
├── main.py                  # فایل اصلی اجرای برنامه (شامل تابع start())
├── wifi.py                  # ماژول مدیریت اتصال WiFi
├── mpu6050.py               # ماژول خواندن داده از حسگر MPU6050
└── ...                      # سایر فایل‌های پشتیبانی یا ابزارهای مورد نیاز
```

### توضیحات فایل‌های اصلی:

- **main.py:**  
  شامل تعریف توابع غیرهمزمان برای اتصال WiFi، ایجاد سرورهای MPU و سروو، و تابع اصلی `main()` برای اجرای همزمان آن‌ها.

- **wifi.py:**  
  مدیریت اتصال به WiFi، شامل توابع `connect_wifi()`, `ensure_wifi_connection()` و متغیر `wlan`.

- **mpu6050.py:**  
  کلاس `MPU6050` جهت خواندن داده‌های شتاب‌سنج و ژیروسکوپ و ارائه متدهای `read_accel_data()` و `read_gyro_data()`.

---

## نصب و راه‌اندازی

### 1. کلون یا دانلود پروژه

```bash
git clone https://github.com/Ali-Rashidi-80/UnityMotionControl.git
cd UnityMotionControl
```

### 2. پیکربندی WiFi

- فایل `wifi.py` را باز کرده و تنظیمات مربوط به **SSID** و **Password** شبکه خود را وارد کنید.

### 3. آپلود فایل‌ها به میکروکنترلر

از ابزارهایی مانند [ampy](https://github.com/scientifichackers/ampy) یا [mpremote](https://github.com/micropython/mpremote) برای انتقال فایل‌ها به میکروکنترلر استفاده کنید.

به عنوان مثال با استفاده از mpremote:

```bash
mpremote connect /dev/ttyUSB0 fs put main.py
mpremote connect /dev/ttyUSB0 fs put wifi.py
mpremote connect /dev/ttyUSB0 fs put mpu6050.py
```

### 4. اجرای برنامه

پس از آپلود فایل‌ها به میکروکنترلر، در REPL MicroPython تابع `start()` را اجرا کنید:

```python
import main
main.start()
```

یا می‌توانید `main.py` را به عنوان فایل اصلی (main script) تنظیم کنید.

---

## تنظیمات و پیکربندی

### تنظیمات WiFi

در فایل `wifi.py`، اطلاعات زیر را مطابق با شبکه خود تنظیم کنید:

```python
SSID = "YourNetworkSSID"
PASSWORD = "YourNetworkPassword"
```

### تنظیمات PWM و سروو

در بخش مربوط به سروو در `main.py`، تنظیمات PWM به صورت زیر است:

- **PWM_FREQ:** 50 Hz (فرکانس PWM)
- **PWM_MIN:** 1400 (حداقل مقدار PWM برای زاویه 0 درجه)
- **PWM_MAX:** 8000 (حداکثر مقدار PWM برای زاویه 180 درجه)

> **توجه:** مقادیر PWM ممکن است بسته به نوع سروو یا میکروکنترلر شما نیاز به تنظیم داشته باشند. در صورت نیاز، مقادیر را تغییر دهید.

---

## مثال‌های استفاده

### 1. دریافت داده‌های MPU6050

- **آدرس اتصال:**  
  به وسیله یک کلاینت WebSocket به آدرس IP دستگاه و پورت **8800** متصل شوید.
  
- **داده‌های ارسالی:**  
  پیام‌های JSON شامل موارد زیر ارسال می‌شوند:
  ```json
  {
    "posX": 12.34,
    "posY": -56.78,
    "posZ": 90.12,
    "gyroX": 0.123,
    "gyroY": -0.456,
    "gyroZ": 0.789
  }
  ```
  در این مثال، **posX**, **posY**, **posZ** به ترتیب نشان‌دهنده زاویه‌های محاسبه‌شده (pitch, roll, yaw) و **gyroX**, **gyroY**, **gyroZ** داده‌های ژیروسکوپ می‌باشند.

### 2. کنترل سروو

- **آدرس اتصال:**  
  کلاینت WebSocket به آدرس IP دستگاه و پورت **8765** متصل شود.

- **فرمت پیام‌های کنترلی:**  
  پیام‌های ارسالی باید در قالب JSON و شامل کلیدهای زیر باشند:
  ```json
  {
    "posX": 45,
    "posY": 90,
    "posZ": 135
  }
  ```
  در اینجا هر یک از کلیدها زاویه‌ای بین 0 تا 180 درجه را تعیین می‌کنند که به ترتیب به سرووهای مربوط به محورهای X, Y, Z اعمال می‌شوند.

---

## عیب‌یابی و رفع اشکال

### 1. مشکلات اتصال WiFi

- **نشانه‌ها:**  
  - دستگاه به شبکه WiFi متصل نمی‌شود.
  - آدرس IP دریافت نمی‌شود.
  
- **راه‌حل‌ها:**  
  - بررسی صحت SSID و Password در فایل `wifi.py`.
  - اطمینان از فعال بودن ماژول WiFi در میکروکنترلر.
  - استفاده از دستور `wifi.wifi_status()` برای بررسی وضعیت اتصال.

### 2. خطاهای WebSocket

- **نشانه‌ها:**  
  - عدم برقراری handshake صحیح.
  - قطع ناگهانی ارتباط با کلاینت.
  
- **راه‌حل‌ها:**  
  - بررسی اینکه کلاینت به درستی درخواست handshake ارسال می‌کند.
  - اطمینان از ارسال و دریافت فریم‌های WebSocket طبق استاندارد (مثلاً پیام‌های کوتاه بدون تکه‌بندی).
  - نظارت بر لاگ‌های کنسول برای مشاهده پیام‌های خطا.

### 3. مشکلات سروو

- **نشانه‌ها:**  
  - سروو به زاویه مورد انتظار پاسخ نمی‌دهد.
  - تغییرات زاویه با تاخیر یا نوسان همراه است.
  
- **راه‌حل‌ها:**  
  - بررسی اتصال فیزیکی سرووها و صحت پین‌های تعریف‌شده.
  - تنظیم مجدد مقادیر PWM_MIN و PWM_MAX بسته به نوع سروو.
  - اطمینان از اجرای صحیح تابع `set_angle()` در کلاس `ServoController`.

---

## سهم در توسعه

### گام‌های مشارکت

1. **فورک کردن (Fork):**  
   پروژه را فورک کنید و تغییرات مورد نظر خود را اعمال نمایید.
   
2. **ایجاد شاخه جدید:**  
   یک شاخه (branch) جدید با نام مناسب ایجاد کنید:
   ```bash
   git checkout -b feature/your-feature-name
   ```

3. **ارسال Pull Request:**  
   تغییرات خود را commit کرده و سپس یک Pull Request برای بررسی ارسال کنید.

### گزارش باگ و پیشنهادات

- برای گزارش باگ یا ارسال پیشنهادات، لطفاً از [Issues](https://github.com/Ali-Rashidi-80/UnityMotionControl/issues) استفاده کنید.

---

## مجوز

این پروژه تحت مجوز **MIT** منتشر شده است. لطفاً فایل [LICENSE](LICENSE) را برای اطلاعات کامل مجوز مطالعه کنید.

---

## سازنده

- **Ali Rashidi**  
  [Telegram: @WriteYourway](https://t.me/WriteYourway)  
  [GitHub: Ali-Rashidi-80](https://github.com/Ali-Rashidi-80)

---

## منابع و مراجع

- [مستندات MicroPython](https://docs.micropython.org/)
- [مستندات uasyncio](https://docs.micropython.org/en/latest/library/uasyncio.html)
- [استاندارد WebSocket](https://tools.ietf.org/html/rfc6455)

---

## نتیجه‌گیری

پروژه **UnityMotionControl** یک پلتفرم جامع برای ایجاد سیستم‌های حرکتی هوشمند است. با استفاده از داده‌های حسگر MPU6050 و کنترل دقیق سرووها از طریق WebSocket، این سیستم قابلیت پیاده‌سازی در پروژه‌های رباتیک، سیستم‌های کنترل حرکتی و سایر کاربردهای صنعتی و خانگی را داراست.

در صورت نیاز به پشتیبانی یا همکاری، از طریق کانال‌های ارتباطی فوق با ما در تماس باشید.

---
```